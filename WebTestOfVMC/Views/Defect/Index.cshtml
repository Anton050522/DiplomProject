
@using WebTestOfVMC.Models
@using Microsoft.AspNetCore.Mvc.TagHelpers
@using EnumExt;
@using Microsoft.AspNetCore.Mvc.Rendering;
@using CommonClasses.PaginationAndSort.IndexViewModelClasses
@using RailDBProject.Model;
@using CommonClasses.PaginationAndSort.Filters

@model DefectIndexViewModel

<p class="filter-text">Дефекты</p>
<br />


<div class="table">

    <div id="manipulation-buttons">
        <div class="create-button button__style">
            @await Component.InvokeAsync("DefectInfo")
        </div>
        <div class="edit-button button__style">
            <input type="submit" class="btn btn-outline-dark" value="Редактировать" id="edit-btn" />
        </div>
        <div class="delete-button button__style">
            <input type="submit" class="btn btn-outline-dark" value="Удалить" id="delete-btn" />
        </div>
        <div class="filters">
            <form method="get">
                <div class="form-inline">

                        <p1 class="p1">Организация: </p1>
                        <select name="organisation" asp-items="Model.OrganisationFilter.Organisations" class="form-control"></select>

                        <p1 class="p1">Направление: </p1>
                        <select name="glSection" asp-items="Model.GlobalSectionFilter.GlobalSections" class="form-control"></select>

                        <p1 class="p1">Перегон: </p1>
                        <select name="lcSection" asp-items="Model.LocalSectionFilter.LocalSections" class="form-control"></select>

                        <p1 class="p1">Код дефекта: </p1>
                        <select name="defect" asp-items="Model.DefectFilter.Defects" class="form-control"></select>

                        <input type="submit" value="Применить фильтр" class="btn btn-outline-dark" />
                </div>
            </form>
        </div>

    </div>

    <table class="table">
        <tr class="p1 intable">
            <th class="size-th">
                <p class="p1 th_size">№ п/п</p>
            </th>
            <th>
                <a asp-action="Index"
                   asp-controller="Defect"
                   asp-route-sortOrder="@(Model.DefectSortViewModel.DateOfDetectionSort)"
                   asp-route-name="@(Model.DefectFilter.SelectedName)"
                   asp-route-company="@(Model.DefectFilter.SelectedDefect)"><div class="icon_th"><p class="p1 th_size">Дата обнаружения </p><img src="~/images/sort.png" id="sort" /></div></a>

            </th>

            <th>
                <a asp-action="Index"
                   asp-controller="Defect"
                   asp-route-sortOrder="@(Model.DefectSortViewModel.LocalSectionNameSort)"
                   asp-route-name="@(Model.DefectFilter.SelectedName)"
                   asp-route-company="@(Model.DefectFilter.SelectedDefect)"><div class="icon_th"><p class="p1 th_size">Перегон </p><img src="~/images/sort.png" id="sort" /></div></a>
            </th>

            <th>
                <a asp-action="Index"
                   asp-controller="Defect"
                   asp-route-sortOrder="@(Model.DefectSortViewModel.LocalSectionWaySort)"
                   asp-route-name="@(Model.DefectFilter.SelectedName)"
                   asp-route-company="@(Model.DefectFilter.SelectedDefect)"><div class="icon_th"><p class="p1 th_size">№ пути </p><img src="~/images/sort.png" id="sort" /></div></a>
            </th>

            <th>
                <a asp-action="Index"
                   asp-controller="Defect"
                   asp-route-sortOrder="@(Model.DefectSortViewModel.KilometerSort)"
                   asp-route-name="@(Model.DefectFilter.SelectedName)"
                   asp-route-company="@(Model.DefectFilter.SelectedDefect)"><div class="icon_th"><p class="p1 th_size">Километр </p><img src="~/images/sort.png" id="sort" /></div></a>
            </th>

            <th>
                <a asp-action="Index"
                   asp-controller="Defect"
                   asp-route-sortOrder="@(Model.DefectSortViewModel.PktSort)"
                   asp-route-name="@(Model.DefectFilter.SelectedName)"
                   asp-route-company="@(Model.DefectFilter.SelectedDefect)"><div class="icon_th"><p class="p1 th_size">Пикет </p><img src="~/images/sort.png" id="sort" /></div></a>
            </th>

            <th>
                <a asp-action="Index"
                   asp-controller="Defect"
                   asp-route-sortOrder="@(Model.DefectSortViewModel.PathSort)"
                   asp-route-name="@(Model.DefectFilter.SelectedName)"
                   asp-route-company="@(Model.DefectFilter.SelectedDefect)"><div class="icon_th"><p class="p1 th_size">Звено </p><img src="~/images/sort.png" id="sort" /></div></a>
            </th>

            <th>
                <a asp-action="Index"
                   asp-controller="Defect"
                   asp-route-sortOrder="@(Model.DefectSortViewModel.WaySideSort)"
                   asp-route-name="@(Model.DefectFilter.SelectedName)"
                   asp-route-company="@(Model.DefectFilter.SelectedDefect)"><div class="icon_th"><p class="p1 th_size">Нить </p><img src="~/images/sort.png" id="sort" /></div></a>
            </th>

            <th>
                <a asp-action="Index"
                   asp-controller="Defect"
                   asp-route-sortOrder="@(Model.DefectSortViewModel.ManufactureSort)"
                   asp-route-name="@(Model.DefectFilter.SelectedName)"
                   asp-route-company="@(Model.DefectFilter.SelectedDefect)"><div class="icon_th"><p class="p1 th_size">Производитель </p><img src="~/images/sort.png" id="sort" /></div></a>

            </th>

            <th>
                <a asp-action="Index"
                   asp-controller="Defect"
                   asp-route-sortOrder="@(Model.DefectSortViewModel.ManufactureYearSort)"
                   asp-route-name="@(Model.DefectFilter.SelectedName)"
                   asp-route-company="@(Model.DefectFilter.SelectedDefect)"><div class="icon_th"><p class="p1 th_size">Год прокатки </p><img src="~/images/sort.png" id="sort" /></div></a>

            </th>

            <th>
                <a asp-action="Index"
                   asp-controller="Defect"
                   asp-route-sortOrder="@(Model.DefectSortViewModel.DefectCodeSort)"
                   asp-route-name="@(Model.DefectFilter.SelectedName)"
                   asp-route-company="@(Model.DefectFilter.SelectedDefect)"><div class="icon_th"><p class="p1 th_size">Код дефекта </p><img src="~/images/sort.png" id="sort" /></div></a>
            </th>

            <th>
                <a asp-action="Index"
                   asp-controller="Defect"
                   asp-route-sortOrder="@(Model.DefectSortViewModel.DefectDepthSort)"
                   asp-route-name="@(Model.DefectFilter.SelectedName)"
                   asp-route-company="@(Model.DefectFilter.SelectedDefect)"><div class="icon_th"><p class="p1 th_size">Глубина залегания (H) </p><img src="~/images/sort.png" id="sort" /></div></a>
            </th>

            <th>
                <a asp-action="Index"
                   asp-controller="Defect"
                   asp-route-sortOrder="@(Model.DefectSortViewModel.DefectLenghtSort)"
                   asp-route-name="@(Model.DefectFilter.SelectedName)"
                   asp-route-company="@(Model.DefectFilter.SelectedDefect)"><div class="icon_th"><p class="p1 th_size">Протяженность (L)</p> <img src="~/images/sort.png" id="sort" /></div></a>
            </th>

        </tr>

        @{ int rowNo = 0; }
        @foreach (Defect d in Model.Defects)
        {
    <tr class="table-row" id="@d.DefectId">
        <td>@(rowNo += 1)</td>
        <td>@d.DateOfDetection.ToShortDateString()</td>
        <td>@d.LocalSection.LocalSectionName</td>
        <td>@d.LocalSection.LocalWayNumber</td>
        <td>@d.Kilometer</td>
        <td>@d.Pkt</td>
        <td>@d.Path</td>
        <td>@d.WaySide.GetEnumDescription()</td>
        <td>@d.Manufacture.GetEnumDescription()</td>
        <td>@d.ManufactureYear</td>
        <td>@d.DefectCode.GetEnumDescription()</td>
        <td>@d.DefectDepth</td>
        <td>@d.DefectLenght</td>

    </tr>
        }

    </table>
</div>

@if (Model.PageView.HasPreviousPage)
{
    <a asp-action="Index"
       asp-route-page="@(Model.PageView.PageNumber - 1)"
       asp-route-name="@(Model.DefectFilter.SelectedName)"
       asp-route-company="@(Model.DefectFilter.SelectedDefect)"
       asp-route-sortorder="@(Model.DefectSortViewModel.Current)"
       class="btn  btn-outline-dark">
        <i class="glyphicon glyphicon-chevron-left"></i>
        Назад
    </a>
}
@if (Model.PageView.HasNextPage)
{
    <a asp-action="Index"
       asp-route-page="@(Model.PageView.PageNumber + 1)"
       asp-route-name="@(Model.DefectFilter.SelectedName)"
       asp-route-company="@(Model.DefectFilter.SelectedDefect)"
       asp-route-sortorder="@(Model.DefectSortViewModel.Current)"
       class="btn btn-outline-dark">
        Вперед
        <i class="glyphicon glyphicon-chevron-right"></i>
    </a>
}

<form asp-action="UpdateDefect" asp-controller="Defect" asp-route-id="id" data-ajax="true"
      data-ajax-method="POST" data-ajax-success="onUpdate">

    <div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="text-center-modal">
                        <div class="form-group">
                            <p id="p1">Редактирование</p>

                            <div id="defectDiv"></div>

                            <div class="form-group">
                                <input type="submit" class="btn btn-outline-dark" value="Сохранить изменения" id="sub" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</form>

@section Scripts{

    <script>
        
        function onSuccess(data) {
            $(document).on("ajaxSuccess", function () {

                    alert(data.emailMessage);
                    window.location = data.url;
            });
        }

        function onUpdate(data) {
            $(document).on("ajaxSuccess", function () {

                alert(data.emailMessage);
                window.location = data.url;
            });
        }

        var clicked = false;
        var element = null;

        var defectDiv = $("#defectDiv");
        var selectDiv = $("#selectDiv");

        $(document).ready(function () {
            $(".multidropdown").select2();
            $(".edit-button").hide();
            $(".delete-button").hide();

            $(".table-row").click(function () {

                if (!clicked)
                {
                    element = $(this).attr("id");
                    $(this).css({ 'backgroundColor': '#fff', 'color': '#000' });
                    clicked = true;
                    $(".edit-button").show();
                    $(".delete-button").show();
                }
                else
                {
                    if ($(this).attr("id") == element) {
                        $(this).css({ 'backgroundColor': '', 'color': '' });
                        clicked = false;
                        $(".edit-button").hide();
                        $(".delete-button").hide();
                    }
                    $(".table-row").click(function () { return false });

                    if ($(this).attr("id") != element) {
                        alert("Для выбора новой записи разактивируйте ранее выбранную!")
                    }
                };
            });


            $(".globalSect").change(function () {
                var txt = $('.dropDownId :selected').text();
                alert(txt);

                $.ajax({
                    url: "@Url.Action("GetLocalFromGlobal","Defect")",
                    type: "post",
                    cache: false,
                    data: { 'name': txt },
                    success: function (data) {
                        selectDiv.html(data);
                    },
                });
            });

            $("#delete-btn").click(function () {
                $.ajax({
                    url: "@Url.Action("DeleteDefect","Defect")",
                    type: "POST",
                    dataType: "html",
                    data: { id: element },
                    success: function (data) {
                        alert("Удаление прошло успешно!")
                        window.location.reload();
                    }
                });
            });

            $("#edit-btn").click(function ()
            {
                $.ajax({
                        url: "@Url.Action("GetOne", "Defect")",
                        type: "GET",
                        dataType: "html",
                        data: { id: element },
                    success: function (data) {
                        defectDiv.html(data);

                        $("#updateModal").modal("show");
                    }
                });
            });
        });

    </script>
}